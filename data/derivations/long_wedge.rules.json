{
  "meta": {
    "system_id": "long_wedge",
    "system_name": "Long Wedge System",
    "rule_version": "v1.0",
    "ssot_role": "derivations",
    "references": {
      "profile": "systems/long_wedge/profile.json",
      "logic": "systems/long_wedge/logic.json",
      "anchors": "systems/long_wedge/anchors.json",
      "manual": "long_wedge_base_manual.txt"
    },
    "notes": [
      "All calculations are performed strictly in sys-domain.",
      "Coordinates (Fg/Rg) are used only for anchor lookup and display mapping.",
      "This system has no iteration, no convergence, and no conditional branching in formula."
    ]
  },

  "inputs": {
    "required": ["track", "CO", "1C", "2C"],
    "validation": {
      "track_required": true,
      "rail_required": true,
      "axis_required": true,
      "error_on_missing": true
    }
  },

  "axis_inference": {
    "rule": "determine axis by rail",
    "mapping": {
      "TOP": "x",
      "BOTTOM": "x",
      "LEFT": "y",
      "RIGHT": "y"
    },
    "validation": "input mark must include rail"
  },

  "safety": {
    "no_extrapolation": true,
    "clamp": true,
    "offset_fg2rg": 2.25,
    "m_min": 0.05,
    "theta_t_max": 68
  },

  "pipeline": [
    {
      "step": 1,
      "name": "resolve_sys_from_anchors",
      "description": "Resolve CO_sys, 1C_sys, and 2C_sys from anchors under the selected track.",
      "rules": {
        "source": "anchors.trajectories[track].anchors",
        "labels": ["CO", "1C", "2C"],
        "interpolation": {
          "method": "linear",
          "clamp": true,
          "no_extrapolation": true
        }
      },
      "outputs": ["CO_sys", "1C_sys", "2C_sys"]
    },

    {
      "step": 2,
      "name": "compute_HP_sys",
      "description": "Compute HP_sys using the Long Wedge formula.",
      "formula": {
        "expr": "HP_sys_raw = 1C_sys - (CO_sys * 2C_sys)",
        "vars": ["1C_sys", "CO_sys", "2C_sys"]
      },
      "post_process": {
        "clamp_range": [0, 80],
        "expr": "HP_sys = clamp(HP_sys_raw, 0, 80)"
      },
      "outputs": ["HP_sys"]
    },

    {
      "step": 3,
      "name": "map_HP_sys_to_coord",
      "description": "Map HP_sys to display coordinates using HP anchors of the selected track.",
      "rules": {
        "source": "anchors.trajectories[track].anchors",
        "label": "HP",
        "sys_to_coord": {
          "method": "linear",
          "clamp": true,
          "no_extrapolation": true
        }
      },
      "outputs": ["mark_HP"]
    },

    {
      "step": 4,
      "name": "fixed_tip",
      "description": "Long Wedge system uses a fixed straight hit-point.",
      "rules": {
        "tip": {
          "mode": "fixed",
          "position": "12:00"
        }
      },
      "outputs": ["tip"]
    }
  ],

  "output_mark_policy": {
    "sys_value": {
      "preserve": true,
      "note": "HP_sys is the final computed system value."
    },
    "coordinate_value": {
      "clamp_to_anchor_range": true,
      "note": "Display coordinates are clamped to physical anchor bounds."
    }
  },

  "outputs": {
    "sys": ["CO_sys", "1C_sys", "2C_sys", "HP_sys"],
    "marks": ["mark_HP"],
    "tip": ["tip"]
  },

  "validation_scenarios": {
    "note": "Representative validation cases based on anchor data.",
    "scenarios": [
      {
        "id": "exact_anchor_match",
        "inputs": {
          "track": "B2T_R",
          "CO": { "space": "Fg", "rail": "RIGHT", "axis": "long", "value": 82.25 },
          "1C": { "space": "Fg", "rail": "LEFT", "axis": "long", "value": -2.25 },
          "2C": { "space": "Rg", "rail": "TOP", "axis": "short", "value": 40 }
        },
        "expected": {
          "interpolation": "none",
          "formula": "HP_sys = 1C_sys - (CO_sys * 2C_sys)"
        }
      },
      {
        "id": "interpolation_required",
        "inputs": {
          "track": "B2T_L",
          "CO": { "space": "Fg", "rail": "LEFT", "axis": "long", "value": -2.25 },
          "1C": { "space": "Fg", "rail": "RIGHT", "axis": "long", "value": 82.25 },
          "2C": { "space": "Rg", "rail": "TOP", "axis": "short", "value": 35 }
        },
        "expected": {
          "interpolation": "linear",
          "clamp": "none"
        }
      },
      {
        "id": "out_of_range_clamp",
        "inputs": {
          "track": "T2B_R",
          "CO": { "space": "Fg", "rail": "LEFT", "axis": "long", "value": -2.25 },
          "1C": { "space": "Fg", "rail": "RIGHT", "axis": "long", "value": 82.25 },
          "2C": { "space": "Rg", "rail": "BOTTOM", "axis": "short", "value": -5 }
        },
        "expected": {
          "clamp": "2C_sys clamped at anchor min, HP_sys clamped if needed"
        }
      }
    ]
  }
}
